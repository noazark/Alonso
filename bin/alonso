#!/usr/bin/env node

var exitPrompt = require('../lib/exit-prompt')
var log = require('../lib/log')
var path = require('path')
var ship = require('../lib/ship')
var watch = require('../lib/watch')

var elasticsearchHosts, logpath, shipper, watcher

var logPath = process.argv[2]

if (process.env.ELASTICSEARCH_HOSTS) {
	elasticsearchHosts = process.env.ELASTICSEARCH_HOSTS.split(',')
} else {
	elasticsearchHosts = ['localhost:9200']
}

log.info({event: 'started', target: logPath})

shipper = new ship({
	hosts: elasticsearchHosts,
	sniffOnStart: true,
	apiVersion: "1.0",
})

watcher = new watch(logPath, 250)

watcher.on('error', function (err) {
	log.error(err)
	process.exit(1)
})

watcher.on('data', function (line) {
	shipper.add(line)
})

exitPrompt(function (err) {
	if (err) log.error(err)
	log.info({event: 'finished', target: logPath})
})
